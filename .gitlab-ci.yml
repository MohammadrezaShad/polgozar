image: node:latest

stages:
  - test
  - build
  - deploy

test:
  stage: test
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - node_modules/
  script:
    - npm install
    - npm test

build_production:
  stage: build
  script:
    - apt-get update
    - npm install
    - npm run build
  artifacts:
    paths:
      - build
  only:
    - master

deploy_production:
  image: python:3.6-stretch
  type: deploy
  before_script:
    - pip install awscli
  script:
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws s3 sync --acl public-read --delete build $S3_BUCKET_PRODUCTION
  stage: deploy
  only:
    - master
